<!DOCTYPE html>
<html lang="en">
<head>
    <!-- favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/phipalibunao/CS3_2ndQtr_K18_K21/main/assets/cspairproj_favicon2.png" sizes="any">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/phipalibunao/CS3_2ndQtr_K18_K21/main/assets/cspairproj_favicon2.png">

    <!-- Encoding + mobile responsiveness -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Page info -->
    <title>Fractured Night â€” Calendar</title>
    <meta name="description" content="Webpage about the third act's game.">
    <meta name="author" content="Phipa Libunao, Datu Macalintal">
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

    <!-- Link Stylesheet -->


    <style>
        body{
            background-color: black;
        }
        .bg{
            height: 100vh;
            width: 100vw;
            object-fit: cover;
            position: fixed;
            top: 0;
            left: 0;
            filter: blur(3px);
            user-select: none;
            -webkit-user-drag: none;
            overflow: hidden;
            z-index: -10;
        }
        .box{
            position: absolute;
            color: white;
            text-shadow: 0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black;
            user-select: none;
        }
        .box:hover{
            cursor: grab;
        }
        .box:active{
            cursor: grabbing;
        }
        .stretchbox{
            position: absolute;
            transform-origin: left;
            user-select: none;
        }
        .hole{
            position: absolute;
            text-align: right;
            color: white;
            text-shadow: 0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black;
            user-select: none;
        }
        .container{
            background-color: grey;
            position: absolute;
            box-shadow: 0 5px 10px black;
            animation: slidein 1s;
            transition: 1s ease;
        }

        @keyframes slidein {
            0% {transform: translateX(100vw);}
            100% {transform: translateX(0);}
        }

        p{
            position: relative;
            text-align: right;
            font-size: 4vmin;
            color: white;
            text-shadow: 0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black;
            z-index: 100;
            pointer-events: none;
            user-select: none;
        }
        #timer {
            position: relative;
            text-align: right;
            font-size: 22px;
            margin-bottom: 15px;
            color: white;
            text-shadow: 0 0 4px black;
        }
        #nextChapterBtn {
            display: none;
            margin-top: 15px;
            padding: 10px 20px;
            font-family: 'Special Elite', monospace;
            font-size: 18px;
            color: #0e0e14;
            background: #78a2f7;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            justify-self: center;
            z-index: 10;
        }
        #nextChapterBtn:hover {
            background: #0e5fff;
        }
        #hiddenClue {
            margin-top: 20px;
            padding: 15px;
            font-size: 20px;
            background: rgba(20,20,30,0.9);
            border-radius: 12px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            display: none;
            box-shadow: 0 0 12px rgba(0,0,0,0.8);
            position: relative;
            z-index: 1;
            color: white;
            justify-self: center;
        }

    </style>
</head>
<body>
    <img class="bg" src="https://raw.githubusercontent.com/phipalibunao/CS3_2ndQtr_K18_K21/main/assets/supervisortable.png">
    <p>Assign the pins to the right day on <br> the calendar before the time ends. <br> Use the hints to determine the day. <br> (Calendar starts on Monday.)</p>
    <div id="timer">Time Remaining: <span id="time">300</span>s</div>
    <p id="hinttext"></p>
    <div id="hiddenClue"></div>
    <button id="nextChapterBtn" onclick="proceedChapter()">Proceed to Chapter 4</button>
    

    <script>
        totalBoxes = 7;
        const CONTAINER_SPACE = 50;
        const CONTAINER_LEFT = "100px";
        const BOX_SPACE = 100;
        const SIDE_LENGTH = "80px";

        holes = [];
        boxes = [];
        colors = [];
        
        originalLeft = [];
        originalTop = [];
        boxStays = [];
        correctlyPlaced = [];
        days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        randomDay = [];
        dates = [];
        assignment = [];
        boxSelected = null;
        score = 0;

        timeLeft = 300;
        const timeEl = document.getElementById("time");
        const clueDiv = document.getElementById("hiddenClue");
        const nextBtn = document.getElementById("nextChapterBtn"); 

        const container = document.createElement("div");
        container.style.top = "100px";
        container.classList.add('container');
        document.body.appendChild(container);

        const hinttext = document.getElementById("hinttext");

        create();

        function create() {
            container.style.left = CONTAINER_LEFT;
            document.body.style.overflowX = "hidden";
            container.addEventListener("animationend", start);
            function start() {
                document.body.style.overflowX = "visible";
            }

            for (i = 0; i < 30; i++){
                dates.push(i);
                const hole = document.createElement("div");
                holes.push(hole);
                holes[i].classList.add('hole');
                holes[i].style.width = SIDE_LENGTH;
                holes[i].style.height = SIDE_LENGTH;
                holes[i].style.left = `${(i%7)*BOX_SPACE}px`;
                holes[i].style.top = `${Math.floor(i/7)*BOX_SPACE + CONTAINER_SPACE}px`;
                holes[i].style.backgroundColor = "white";
                holes[i].innerHTML = i+1;

                correctlyPlaced.push(false);

                container.appendChild(holes[i]);
            }

            for (i = 0; i < totalBoxes; i++){
                const box = document.createElement("div");

                colors.push(i);
                boxes.push(box);
                randomDay.push(Math.floor(Math.random() * (8-1)) + 1);

                boxes[i].classList.add('box');
                boxes[i].id = i;
                boxes[i].style.width = SIDE_LENGTH;
                boxes[i].style.height = SIDE_LENGTH;
                boxes[i].style.left = `${(i)*BOX_SPACE}px`;
                boxes[i].style.top = 0;
                
                originalLeft[i] = boxes[i].style.left;
                originalTop[i] = boxes[i].style.top;
                boxStays[i] = true;
                boxes[i].addEventListener("mousedown", move);
                boxes[i].addEventListener("mousemove", hints);

                while (!dates.includes(assignment[i]))
                    assignment[i] = Math.floor(Math.random() * 30);
                dates.splice(dates.indexOf(assignment[i]), 1);
            }
            console.log(assignment);
            console.log(dates);

            for (i = totalBoxes; i > 0; i--){
                color = Math.floor(Math.random() * i);
                boxes[totalBoxes - i].style.backgroundColor = `rgb(${Math.floor(Math.random() * ((colors[color] + 1) * 60 - 20) + 20)}, ${Math.floor(Math.random() * ((colors[color] + 1) * 40 - 10) + 10)}, ${Math.floor(Math.random() * ((colors[color] + 1) * 50 - 10) + 10)})`;
                boxes[totalBoxes - i].innerHTML = totalBoxes - i + 1;
    
                colors.splice(color, 1);

                document.body.appendChild(boxes[totalBoxes - i]);
            }

            container.style.height = `${parseInt(holes[29].style.top) + parseInt(holes[29].style.height) + CONTAINER_SPACE}px`;
            container.style.width = `${parseInt(holes[6].style.left) + parseInt(holes[29].style.width)}px`;

        }
        
        function hints(event) {
            if (boxSelected == null && score < totalBoxes) {
                boxHovered = event.target.id;
                console.log(boxHovered);
                if (assignment[boxHovered] % 7 >= 5)
                    dayType = "weekend";
                else
                    dayType = "weekday";
                hinttext.innerHTML = `Assignment ${parseInt(boxHovered) + 1}: <br><br> 
                                    I should assign this to a ${dayType}. <br>
                                    This should be at row ${Math.floor(assignment[boxHovered]/7 + 1)}. <br>
                                    The assignment should be ${randomDay[boxHovered]} day/s after a ${days.at((assignment[boxHovered] % 7) - randomDay[boxHovered])}. <br><br><br><br>`;
            }
            
        }

        const timerInterval = setInterval(()=>{
            timeLeft--;
            timeEl.textContent=timeLeft;
            if(timeLeft<=0){
                endGame(false);
            }
        },1000);

        function move(event) {
            if (score < totalBoxes){
                boxSelected = event.target.id;
                boxStays[boxSelected] = false;
                boxes[boxSelected].style.transition = "none";
            }
        }

        document.addEventListener("mousemove", moving);
        function moving(event) {
            if (boxStays[boxSelected] == false){
                
                boxes[boxSelected].style.left = `${event.clientX - parseInt(boxes[boxSelected].style.width)/2 + parseInt(window.scrollX)}px`;
            
                boxes[boxSelected].style.top = `${event.clientY - parseInt(boxes[boxSelected].style.height)/2 + parseInt(window.scrollY)}px`;

                for(i = 0; i < 30; i++){
                    if (event.clientX + parseInt(window.scrollX) >= parseInt(holes[i].style.left) + parseInt(container.style.left) && event.clientX + parseInt(window.scrollX) <= parseInt(holes[i].style.left) + parseInt(holes[i].style.width) + parseInt(container.style.left) && event.clientY + parseInt(window.scrollY) >= parseInt(holes[i].style.top) + parseInt(container.style.top) && event.clientY + parseInt(window.scrollY) <= parseInt(holes[i].style.top) + parseInt(holes[i].style.height) + parseInt(container.style.top)){
                        boxes[boxSelected].style.left = `${parseInt(holes[i].style.left) + parseInt(holes[i].style.width)}px`;
                        boxes[boxSelected].style.top = `${parseInt(holes[i].style.top) + parseInt(holes[i].style.height)}px`;
                    }
                } 

                
                
                
            }
        }

        document.addEventListener("mouseup", stay);
        function stay(event) {
            inHole = false;
            for (i = 0; i < 30; i++){
                if (event.clientX + parseInt(window.scrollX) < parseInt(holes[i].style.left) + parseInt(container.style.left) || event.clientX + parseInt(window.scrollX) > parseInt(holes[i].style.left) + parseInt(holes[i].style.width) + parseInt(container.style.left) || event.clientY + parseInt(window.scrollY) < parseInt(holes[i].style.top) + parseInt(container.style.top) || event.clientY + parseInt(window.scrollY) > parseInt(holes[i].style.top) + parseInt(holes[i].style.height) + parseInt(container.style.top)){
                    if (boxSelected != null){
                        if (correctlyPlaced[i] == true && assignment[boxSelected] == i){
                            score = score - 1;
                            correctlyPlaced[i] = false;
                        }
                    }
                }
                else{
                    if (boxSelected != null){
                        inHole = true;
                        if (assignment[boxSelected] == i){
                            if (correctlyPlaced[i] == false){
                                score = score + 1;
                                correctlyPlaced[i] = true;
                            }
                            
                        }
                    }
                }
            }
            if (inHole == false){
                if (boxStays[boxSelected] == false){
                    boxes[boxSelected].style.left = originalLeft[boxSelected];
                    boxes[boxSelected].style.top = originalTop[boxSelected];
                    boxes[boxSelected].style.transition = "ease-out 0.5s";
                }
            }

            if (score == totalBoxes && boxSelected != null){
                console.log("Hooray!");
                endGame(true);
                
            }

            boxStays[boxSelected] = true;
            boxSelected = null;
        }

        function endGame(won){
            clearInterval(timerInterval); // stop timer immediately
            for (i = 0; i < totalBoxes; i++){
                boxes[i].style.cursor = "default";
            }
            clueDiv.style.display="block";
            if(won){
                clueDiv.innerHTML="<strong>Hidden Clue Found!</strong><br>The supervisor wanted to keep the engineer safe because they have low resources and people, so they sent the memo.";
            } else {
                clueDiv.innerHTML="<strong>Time's Up!</strong><br>You couldn't reveal the hidden clue. The story continues with the version the city believes. The supervisor tried to cause the bridge to collapse.";
            }
            nextBtn.style.display="inline-block";
        }

        function proceedChapter(){
            window.location.href = "story4.html";
        }
    </script>
</body>